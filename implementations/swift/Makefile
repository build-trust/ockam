ROOT_DIR := $(realpath $(dir $(firstword $(MAKEFILE_LIST)))/../..)

build: ockam_app_lib
    # the xcode project expect the ockam executable to be found in the release directory
	cp $(ROOT_DIR)/target/debug/ockam $(ROOT_DIR)/target/debug/release
	xcodebuild archive -project ockam/ockam_app/Ockam.xcodeproj/ -scheme "Portals, by Ockam" -configuration Debug -archivePath build/Ockam.xcarchive
	@echo "Build complete.  See build/Ockam.xcarchive for the built app."
	@echo "To execute run: build/Ockam.xcarchive/Products/Applications/Portals,\ by\ Ockam.app/Contents/MacOS/Portals,\ by\ Ockam"
build_release: ockam_app_lib_release xcode_build
xcode_build:
	xcodebuild archive -project ockam/ockam_app/Ockam.xcodeproj/ -scheme "Portals, by Ockam" -configuration Release -archivePath build/Ockam.xcarchive
	@echo "Build complete.  See build/Ockam.xcarchive for the built app."
	@echo "To execute run: build/Ockam.xcarchive/Products/Applications/Portals,\ by\ Ockam.app/Contents/MacOS/Portals,\ by\ Ockam"
xcode_signed_build:
	xcodebuild archive -project ockam/ockam_app/Ockam.xcodeproj/ -scheme "Portals, by Ockam" -configuration Release -archivePath build/Ockam.xcarchive -arch $(ARCH)  CODE_SIGN_IDENTITY="${CODE_SIGN_IDENTITY}"  PROVISIONING_PROFILE_SPECIFIER="${PROVISIONING_PROFILE_SPECIFIER}" DEVELOPMENT_TEAM="${DEVELOPMENT_TEAM}"
ockam_app_lib_release:
	$(MAKE) -f ../rust/Makefile build_release
ockam_command_release:
	$(MAKE) -f ../rust/Makefile build_release_ockam_command
ockam_app_lib:
	$(MAKE) -f ../rust/Makefile build
package: ockam_command_release build_release package_only
package_only:
	xcodebuild -exportArchive -archivePath build/Ockam.xcarchive/ -exportPath build/ -exportOptionsPlist ockam/ockam_app/Ockam/ExportOptions.plist
	rm -f build/Ockam.dmg
	create-dmg \
			--no-internet-enable \
			--volname "Portals, by Ockam - Installer" --hide-extension "Portals, by Ockam.app" \
			--background ockam/ockam_app/packaging/installer-background.png \
			--window-size 600 400 --icon-size 128 \
			--icon "Portals, by Ockam.app" 126 185 --app-drop-link 466 185 \
			build/Ockam.dmg "build/Portals, by Ockam.app/"
test:
	@echo "No test command specified."
run: build
	"build/Ockam.xcarchive/Products/Applications/Portals, by Ockam.app/Contents/MacOS/Portals, by Ockam"
run_release: build_release
	"build/Ockam.xcarchive/Products/Applications/Portals, by Ockam.app/Contents/MacOS/Portals, by Ockam"
lint:
	@echo "No lint command specified."
clean:
	rm -rf "build/"
very_clean: clean
	$(MAKE) -f ../rust/Makefile clean_ockam_app_lib

.PHONY: \
	build_release build_package \
	test lint clean very_clean \
	ockam_app_lib_release ockam_app_lib \
	ockam_command_release
