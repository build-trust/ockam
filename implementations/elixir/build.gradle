
plugins {
  id 'network.ockam.gradle.host' version '1.0.0'
  id 'network.ockam.gradle.builders' version '1.0.0'
}

task build {
  onlyIf { host.debianBuilder.enabled }
  doLast {
    builderExec 'debian', {
      script '''
        mix do local.hex --if-missing --force
        mix do local.rebar --force
        mix do deps.get, compile
      '''
    }
  }
}

task test {
  onlyIf { host.debianBuilder.enabled }
  doLast {
    builderExec 'debian', {
      script '''
        mkdir -p ../c/_build/x86_64-unknown-linux-gnu
        cd ../c/_build/x86_64-unknown-linux-gnu
        cmake -DCMAKE_BUILD_TYPE=Debug -DOCKAM_BUILD_TESTS=ON -DOCKAM_TARGET_PLATFORM="linux" ../..
        cmake --build . --config Debug --target ockam_key_agreement_tests_xx_full
        cd ../../../elixir

        mix do local.hex --if-missing --force
        mix do local.rebar --force
        mix deps.get
        OCKAM_C_BUILD_DIR="$(pwd)/../c/_build/x86_64-unknown-linux-gnu" mix test
      '''
    }
  }
}

task clean {
  doLast {
    delete 'priv/native'
    delete '_build'
  }
}
